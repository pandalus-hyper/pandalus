<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Pandalous</title>

    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{url_for('static', filename='hacker.css')}}" rel="stylesheet"/>
    <link rel="stylesheet" href="{{url_for('static', filename='jquery-jvectormap-2.0.3.css')}}" type="text/css" media="screen"/>

    <!--[if lt IE 9]
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

  </head>

  <body>

    <!--navgation bar-->
    <nav class="navbar navbar-inverse">
      <div class="container-fluid">
        <div class="navbar-header">
          <!--toggle botton for smart phone-->
          <button type="button" class="navbar-toggle collapsed" 
            data-toggle="collapse" data-target="#navbar" aria-expanded="false" 
            aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <!--logo-->
          <a class="navbar-brand" href="#">Pandalous</a>
        </div>

        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="#">Home</a></li>
            <li><a href="#">About</a></li>
            <li><a href="#">Menu</a></li>
            <li><a href="#">hogehoge</a></li>
          </ul>
        </div><!--/.nav-collapse -->

      </div><!--/.container-fluid -->
    </nav>


    <div class="container-fluid">
      <div class="row">
        <div class="col-xs-2">
          <table class="table text-danger">
            <thead>
              <tr><th>SRC</th><th>DEST</th><th>PORT</th></tr>
            </thead>
            <tbody>
              <tr><td>choruru</td><td>taisho</td><td>22</td></tr>
              <tr><td>motomu</td><td>taisho</td><td>80</td></tr>
              <tr><td>hogehoge</td><td>taisho</td><td>443</td></tr>
              <tr><td>hogehoge</td><td>taisho</td><td>443</td></tr>
            </tbody>
          </table>
        </div>
        <div class="col-xs-10">
          <!--map-->
          <div id="map" style="width: 80vw; height: 80vh;">
          </div>
        </div>
      </div>
    </div>

    <div>
    <button onclick="add();">add()</button>
    </div>

    <div class="container-fluid">
    Footer
    </div>

    <link href="{{url_for('static', filename='hacker.css')}}" rel="stylesheet"/>

    <script src="{{url_for('static', filename='jquery-1.11.3.js')}}"></script>
    <script src="{{url_for('static', filename='jquery-jvectormap-2.0.3.min.js')}}"></script>
    <script src="{{url_for('static', filename='jquery-jvectormap-world-mill.js')}}"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <script src="http://d3js.org/d3.v3.min.js"></script>

    <script type="text/javascript">
      var map;
      var objs = [];
      var flow;
      var flownum = 0;

      $(function(){
        $('#map').vectorMap({
          map: 'world_mill',
          onViewportChange: resize,
        });

	map = document.getElementById("map"); 
	var svg = map.getElementsByTagName("svg");
	svg[0].id = "marker"
        flow = d3.select("#marker");
        map = $('#map').vectorMap('get', 'mapObject');
        $(window).resize(resize);
      });


     function drawpkt(fnumber, id, totalpkt, cx, cy){
	  	var pathid = "path" + fnumber.toString();
    		flow.select('#' + "circle" + fnumber.toString() + "-" + id.toString())
    		.transition()
    		.duration(700+(1000)/totalpkt*id)
    		.ease("sin")
    		.attrTween(
      			'transform', function(d) {
				  return function(t) {
      	    				var p = flow.select("#"+pathid).node().getPointAtLength(flow.select("#"+pathid).node().getTotalLength()*t);
					if(t == 1){
						if(id == totalpkt-1){
      	    				flow.select("#"+pathid).remove();
						}
    					flow.select('#' + "circle" + fnumber.toString() + "-" + id.toString()).remove();
					}
      	    				return "translate(" + (p.x-cx) + "," + (p.y - cy) + ")";
				  }
      			}
      	    	)
     };


     function drawflow(obg, fnumber){
          dst = map.latLngToPoint(obj.src[0], obj.src[1]);
          src = map.latLngToPoint(obj.dst[0], obj.dst[1]);
    	  var x1 = src.x;
    	  var y1 = src.y;
    	  var x2 = dst.x;
    	  var y2 = dst.y;
    	  var cx = x1;
    	  var cy = y1;
    	  var vx1 = 100;
    	  var vy1 = 0;
    	  var vx2 = x2 - x1;
    	  var vy2 = y2 - y1;
    	  var sita = 360 * Math.atan2(vx1*vy2 - vy1*vx2, vx1*vx2+vy1*vy2)/2/Math.PI
    	  var rx = Math.sqrt((x2-x1)*(x2-x1) + (y2 - y1)*(y2-y1))/2;
    	  var ry = rx/2;
	  var pathid = "path" + fnumber.toString();
	  var circleids = [];
	  for(id = 0; id < 10; id++){
		  circleids.push("circle" + fnumber.toString() + "-" + id.toString());
	  }
	  var circleid = "circle" + fnumber.toString();
	flow.append('path')
	.attr({
            'id':pathid,
            'd': "M" + x1 + " " + y1 + " A " + rx + " " + ry +"  "+ sita  +" 0 1 " + x2 + " " + y2,
            'stroke': 'none',
            'fill': 'none',
            'stroke-width': 2,
          });


	  for(id = 0; id < circleids.length; id++){
	flow.append('circle')
	.attr({
            'id': "circle" + fnumber.toString() + "-" + id.toString(),
            'cx': cx,
            'cy': cy,
            'r': 5,
	    'fill':"red",
          });
	  }

	  for(id = 0; id < circleids.length; id++){
		drawpkt(fnumber, id, circleids.length, cx, cy);
	  };




     }


      function drawflows() {
        for(i = 0; i < objs.length; i++){
          obj = objs[i];
	  drawflow(obj, flownum);
	  flownum += 1;
	  if(flownum == 1000000){
		  flownum = 0;
	  }
      };
      objs = [];
      };





      function resize(){
	//alert("resie draw");
        //draw();
      }

      function $s(elem) {
        return $(document.createElementNS('http://www.w3.org/2000/svg', elem));
      }

      

      function add(){
        var $path = $(document.createElementNS('http://www.w3.org/2000/svg', 'path'));
        var $circle = $(document.createElementNS('http://www.w3.org/2000/svg', 'circle'));

        objs.push({
          src:[37, -122],
          dst:[35, 139],
        });
        objs.push({
          src:[50, -100],
          dst:[80, 50],
        });

        drawflows();
      }
    </script>

    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.5/socket.io.min.js"></script>
    <script type="text/javascript" charset="utf-8">
        $(document).ready(function(){
            namespace = ''; // change to an empty string to use the global namespace
            var socket = io.connect('http://' + document.domain + ':' + location.port + namespace);
	    socket.on('pktdata', function(msg) {
		    for (var i = 0; i < msg.data["data"].length; i++) {
		    obj = jQuery.parseJSON(msg.data["data"][i]);
		    objs.push({
			src:[Number(obj["srclat"]), Number(obj["srclog"])],
			dst:[Number(obj["dstlat"]), Number(obj["dstlog"])],
			});

		    };
        drawflows();
		    });

        });




    </script>
  </body>
</html>
